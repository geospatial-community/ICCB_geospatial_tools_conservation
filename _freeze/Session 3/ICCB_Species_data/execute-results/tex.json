{
  "hash": "67061a7af84714b5c6339e0707a70f5d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"ICCB Species data download\"\nauthor: \"Scott Forrest and Charlotte Patterson\"\ndate: \"2025-06-06\"\nexecute: \n  cache: false\n# bibliography: references.bib\ntoc: true\nnumber-sections: false\nformat: \n  html:\n    self-contained: true\n    code-fold: show\n    code-tools: true\n    df-print: paged\n    code-line-numbers: true\n    code-overflow: scroll\n    fig-format: png\n    fig-dpi: 300\n  pdf:\n    geometry: \n      - top=30mm\n      - left=30mm\neditor:\n  source\nabstract: |\n  In this script we are downloading data from ALA (with an option for GBIF) for koalas (Phascolarctos cinereus) in the South-East Queensland (SEQ) region. We are then cleaning the data and in other scripts creating a species distribution model for current and future climate scenarios.\n---\n\n\n\n\n\n\n## Install packages\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# install.packages(\"galah\")\n```\n:::\n\n\n\n\n\n\n## Import packages\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'dplyr'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(purrr)\nlibrary(ggplot2)\nlibrary(galah)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\ngalah: version 2.1.1\ni Default node set to ALA (ala.org.au).\ni See all supported GBIF nodes with `show_all(atlases)`.\ni To change nodes, use e.g. `galah_config(atlas = \"GBIF\")`.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'galah'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:dplyr':\n\n    desc\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nThe following object is masked from 'package:stats':\n\n    filter\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(terra)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nterra 1.8.50\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(sf)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nLinking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(predicts)\nlibrary(tidyterra)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n\nAttaching package: 'tidyterra'\n\nThe following object is masked from 'package:stats':\n\n    filter\n```\n\n\n:::\n:::\n\n\n\n\n\n\n## To cite the `galah` package\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Package citation\ncitation(package = \"galah\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nTo cite galah in publications use:\n\n  Westgate M, Kellie D, Stevenson M, Newman P (2025). _galah:\n  Biodiversity Data from the GBIF Node Network_. R package version\n  2.1.1, <https://CRAN.R-project.org/package=galah>.\n\nA BibTeX entry for LaTeX users is\n\n  @Manual{,\n    title = {galah: Biodiversity Data from the GBIF Node Network},\n    author = {Martin Westgate and Dax Kellie and Matilda Stevenson and Peggy Newman},\n    year = {2025},\n    note = {R package version 2.1.1},\n    url = {https://CRAN.R-project.org/package=galah},\n  }\n```\n\n\n:::\n:::\n\n\n\n\n\n\n## Load South East Queensland (SEQ) boundary\n\nWe made this boundary in the 'ICCB_Environmental_data.qmd' script. \nAlso load local government area polygons (LGAs) just for plotting.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSEQ_extent.vect <- vect(\"Data/Environmental_variables/SEQ_extent.shp\")\n\n# Define an sf object as well\nSEQ_extent <- st_as_sf(SEQ_extent.vect, \n                        coords = c(\"x\", \"y\"), \n                        crs = 3112)\n                        \n\n\n# Load the study area shapefile\nLGA <- st_read(\"Data/Environmental_variables/Local_Government_Areas.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `Local_Government_Areas' from data source \n  `/Users/scottforrest/Library/CloudStorage/OneDrive-QueenslandUniversityofTechnology/PhD - Scott Forrest/GIT/ICCB_geospatial_tools_conservation/Session 3/Data/Environmental_variables/Local_Government_Areas.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 78 features and 8 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 137.9946 ymin: -29.17927 xmax: 153.5519 ymax: -9.087991\nGeodetic CRS:  GDA94\n```\n\n\n:::\n\n```{.r .cell-code}\n# Check the coordinate reference system (CRS)\nst_crs(LGA)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: GDA94 \n  wkt:\nGEOGCRS[\"GDA94\",\n    DATUM[\"Geocentric Datum of Australia 1994\",\n        ELLIPSOID[\"GRS 1980\",6378137,298.257222101,\n            LENGTHUNIT[\"metre\",1]]],\n    PRIMEM[\"Greenwich\",0,\n        ANGLEUNIT[\"degree\",0.0174532925199433]],\n    CS[ellipsoidal,2],\n        AXIS[\"geodetic latitude (Lat)\",north,\n            ORDER[1],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        AXIS[\"geodetic longitude (Lon)\",east,\n            ORDER[2],\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n    USAGE[\n        SCOPE[\"Horizontal component of 3D system.\"],\n        AREA[\"Australia including Lord Howe Island, Macquarie Island, Ashmore and Cartier Islands, Christmas Island, Cocos (Keeling) Islands, Norfolk Island. All onshore and offshore.\"],\n        BBOX[-60.55,93.41,-8.47,173.34]],\n    ID[\"EPSG\",4283]]\n```\n\n\n:::\n\n```{.r .cell-code}\n# Convert to WGS84\nLGA <- LGA %>% st_transform(3112)\n\n# Select local govt. areas for South East Queensland\nLGA_SEQ <- LGA %>% \n  filter(lga %in% c(\"Brisbane City\", \n                    \"Moreton Bay City\", \n                    \"Logan City\", \n                    \"Ipswich City\", \n                    \"Redland City\", \n                    \"Scenic Rim Regional\", \n                    \"Somerset Regional\", \n                    \"Lockyer Valley Regional\", \n                    \"Gold Coast City\", \n                    \"Sunshine Coast Regional\", \n                    \"Toowoomba Regional\", \n                    \"Noosa Shire\"))\n```\n:::\n\n\n\n\n\n\n\n\n## Atlas of Living Australia using \"galah\" package\n\nTo access records from the ALA, you will need to be registered.\n\nThere are two registration options:\n\n1.  If you are affiliated with an Australian institution, you should be able to register for ALA through your institution. Find your institution in the list of institutions when you select 'Login' [on the ALA website](https://www.ala.org.au/). Follow the prompts to enter your institution email and password. If your institution is not listed, you will need to register for an ALA account.\n\n2. If you are not affiliated with an Australian institution, you will need to register for an ALA account. You can do this by selecting 'Register' [on the ALA website](https://www.ala.org.au/). Follow the prompts to enter your email and password.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngalah_config(atlas = \"ALA\",\n             # username = \"scott.forrest@hdr.qut.edu.au\",\n             email = \"scott.forrest@hdr.qut.edu.au\"\n             # password = \"Password\"\n             )\n```\n:::\n\n\n\n\n\n\n## Download koala data from ALA\n\nUsually you would check that the CRS for the occurrences is the same as the shapefile. However, we know that the `galah' package operates in WGS84.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkoala_occurrences <- galah_call() %>% \n  galah_identify(\"Phascolarctos cinereus\") %>% \n  galah_filter(\n    stateProvince == \"Queensland\",\n    occurrenceStatus == \"PRESENT\"\n  ) %>% \n  atlas_occurrences()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRequest for 93456 occurrences placed in queue\nCurrent queue length: 1\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n-----\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDownloading\n```\n\n\n:::\n:::\n\n\n\n\n\n## Clean koala data\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a map using ggplot2\nggplot() +\n  geom_sf(data = LGA, color = \"black\") +\n  geom_point(data = koala_occurrences,\n             aes(x = decimalLongitude,\n                 y = decimalLatitude),\n             color = \"blue\", size = 0.5) + # Add points for occurrences\n  ggtitle(\"Koala occurrences across Queensland\") +             # Add title\n  theme_bw()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 215 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](ICCB_Species_data_files/figure-pdf/unnamed-chunk-7-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n## Filter by SEQ region\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check for missing values in decimalLongitude and decimalLatitude\npaste0(\"Number of NAs in 'longitude' \", sum(is.na(koala_occurrences$decimalLongitude)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Number of NAs in 'longitude' 215\"\n```\n\n\n:::\n\n```{.r .cell-code}\npaste0(\"Number of NAs in 'latitude' \", sum(is.na(koala_occurrences$decimalLatitude)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Number of NAs in 'latitude' 215\"\n```\n\n\n:::\n\n```{.r .cell-code}\nkoala_occ_sf <- koala_occurrences %>% \n  drop_na(decimalLongitude, decimalLatitude) %>% # remove NA values\n  st_as_sf(coords = c(\"decimalLongitude\", \"decimalLatitude\"), \n           crs = 4326) %>%\n  st_transform(3112) %>% # Transform to the same CRS as SEQ_extent\n  st_intersection(SEQ_extent) %>% # Mask to extent\n  distinct() # drop any duplicated records\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: attribute variables are assumed to be spatially constant throughout\nall geometries\n```\n\n\n:::\n:::\n\n\n\n\n\n\n## Plot the filtered data\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a map using ggplot2\nggplot() +\n  geom_sf(data = SEQ_extent.vect, fill = \"purple3\", alpha = 0.5, color = \"black\", size = 0.2) +\n  geom_sf(data = koala_occ_sf,                           # Add koala presence locations\n          aes(geometry = geometry),\n             color = \"blue\", size = 0.5) +               # Add points for occurrences\n  ggtitle(\"Koala occurrences in South East Queensland\") +      # Add title\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](ICCB_Species_data_files/figure-pdf/unnamed-chunk-9-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n# Sample background points\n\nWe need to load the environmental covariate grid to use as our template grid for creating background points. We generated the environmental covariates in the 'ICCB_Environmental_data.qmd' script. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncovs <- rast(\"Data/Environmental_variables/current_bioclim.tif\")\n\n# Make a blank raster of all 1s of the same dimensions as our covariate grid\ndomain <- covs[[1]]\nvalues(domain) <- 1\n\n\n# Mask extent by SEQ boundary\ndomain <- terra::mask(domain, SEQ_extent.vect, updatevalue = NA)\n\nnames(domain) <- \"SEQ_extent\"\n\nplot(domain)\n```\n\n::: {.cell-output-display}\n![](ICCB_Species_data_files/figure-pdf/unnamed-chunk-10-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\n# Set the location and number of background points\n# Random sampling at first\n# The mask means that any NA (not SEQ) locations do not include background points\nbackground <- predicts::backgroundSample(mask = domain, \n                                         n = 2500)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in predicts::backgroundSample(mask = domain, n = 2500): generated\nrandom points = 0.5944 times requested number\n```\n\n\n:::\n\n```{.r .cell-code}\n# Convert to terra SpatVector object\nbackground <- terra::vect(background, crs = \"EPSG:3112\")\n\n# Convert background points (SpatVector) to data frame\nbackground_df <- as.data.frame(geom(background))\n\nkoala_occ.vect <- vect(koala_occ_sf)\n\n# Plot the presences (blue) and the background points (grey)\nggplot() +\n  geom_sf(data = SEQ_extent, fill = \"purple3\", alpha = 0.5, color = \"black\", size = 0.2) +\n  geom_spatvector(data = background,                           # Add koala presence locations\n             color = \"gray\", cex = 0.5) +               # Add points for occurrences\n  geom_spatvector(data = koala_occ.vect, \n                  aes(geometry = geometry), \n                  color = \"blue\", cex = 0.5) + # Add background points\n  ggtitle(\"Koala occurrences (blue) and background points (grey) in South East Queensland\") +      # Add title\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](ICCB_Species_data_files/figure-pdf/unnamed-chunk-10-2.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n## Save koala presences and background points \nThis ensures quick upload in the future and that these records can be used among models. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwriteVector(koala_occ.vect, \"Data/Biological_records/SEQ_koala_occurrences.shp\", overwrite = T)\n\nwriteVector(background, \"Data/Biological_records/background_points_2.5k_random.shp\", overwrite = T)\n```\n:::\n",
    "supporting": [
      "ICCB_Species_data_files/figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}